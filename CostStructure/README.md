**Анализ затрат в удобном, понятном и очень наглядном виде. В отчете выводится структура затрат на выпуск в виде дерева, с разузлованием вложенных затрат. Также выводится структура затрат в виде диаграммы. Работает для УПП и КА, РАУЗа и партионного учета.**

Отчет предназначен для анализа затрат на выпуск продукции и услуг с помощью **иерархической структуры** затрат.

Формирование структуры затрат выполняется в три этапа:

1. Получение стартовых данных о выпуске продукции и услуг, для которых строится структура себестоимости;
2. Получение данных о выпуске и затратах на выпуск продукции и услуг;
3. Построение иерархической структуры затрат по результатам сопоставления данных о выпуске и затратах из п.2.

### Настройки и формирование стартовых данных о выпуске продукции и услуг

Настройки выполняются на закладке **«Выпуск»**. Можно настраивать:

 - Период анализируемого выпуска;
 - Отбор по аналитике выпуска (продукция, подразделение и т.д.);
 - Аналитику выпуска (Подразделение, Номенклатурная группа, Заказ).
 
### Настройки и формирование данных о выпуске и затратах на выпуск продукции и услуг

Настройки выполняются на закладках **«Затраты»** и **«Сворачиваемые статьи затрат»**. Можно настраивать:

- Период затрат. По умолчанию он равен периоду выпуска. Можно, например, анализировать выпуск за месяц, а затраты брать за полгода (при длинном производственном цикле);
- Отбор по аналитике затрат (статья затрат, затрата и т.д.);
- Аналитику затрат. **Внимание**: настройки аналитки затрат влияют на алгоритм сопоставления выпусков и затрат на выпуск (см. ниже);
- Сворачиваемые статьи затрат - по указанным статьям не будет производиться разузлование. Например, это актуально для статей, по которым отражается множество затрат по небольшим суммам (ручной инструмент, вспомогательное сырье и т.д.).

### Алгоритм построения иерархической структуры затрат

Построение структуры затрат осуществляется в следующем порядке:

1. Получение стартовых данных о выпуске. На данном этапе определяется, для какой продукции будет выполняться анализ затрат;
2. Получение данных о выпусках и затратах на выпуск без ограничений (кроме отбора и сворачиваемых статей). Полученные данные помещаются в кэш для повторного использования при построении структуры затрат, при неизменных ключевых настройках;
3. Пошаговое сопоставление данных о затратах на выпуск и выпусках - построение структуры затрат:
- для каждого стартового выпуска ищутся затраты на выпуск, согласно аналитике затрат;
- найденные затраты выводятся в иерархию структуры затрат стартового выпуска;
- для каждой затраты, вид воспроизводства которой - «Производство» (кроме сворачиваемых) ищутся выпуски;
- для каждого выпуска затраты ищутся затраты на выпуск, которые помещаются в структуру затрат;
- и т.д.
- если для затраты с видом воспроизводства «Производство» не найдены затраты на выпуск, будет выдано соответствующее предупреждение, и строка будет окрашена в розовый цвет.

### Пошаговый поиск при построении структуры затрат

Предназначен для случаев, когда для какой-либо затраты с видом воспроизводства «Производство» не найдены затраты на выпуск.

Пошаговый поиск настраивается на закладке «Пошаговый поиск»:

- Флаг «Искать затраты вне периода затрат» включает/выключает пошаговый поиск;
- «Граница поиска затрат» определяет, до какой самой ранней даты можно искать затраты;
- «Шаг поиска затрат» определяет размер выборки поиска затрат на каждом шаге построения структуры затрат.

### Алгоритм пошагового поиска:

1. Выполняются все действия по построению структуры затрат, в рамках периодов затрат и выпуска (без пошагового поиска);
2. По ходу построения структуры затрат составляется список затрат с видом воспроизводства «Производство», для которых не найдены затраты на выпуск;
3. Для данного списка осуществляется построение структуры затрат по стандартному алгоритму, с постепенным сдвигом периода затрат на длину шага поиска затрат, вплоть до границы поиска затрат.

### Представление данных

Для всестороннего анализа затрат, данные  выводятся в пяти различных формах:

1. **Полная структура** - вся структура затрат без каких-либо ограничений. Данный режим рекомендуется для анализа структуры, распределения по переделам, вхождения затрат и т.д.;
2. **Свернутая структура** - выводятся только конечные затраты в разрезе стартового выпуска. Данный режим рекомендуется для анализа затрат на выпуск готовой продукции при многопередельном производстве. Например, чтобы увидеть стоимость электроэнергии, которая потреблялась на каждом переделе, в составе готовой продукции;
3. **Плоская структура** - выводятся только конечные затраты без иерархии. Данный режим рекомендуется для анализа затрат в общем объеме, понесенном при производстве стартовых выпусков;
4. **Отчет** - вся структура затрат без каких-либо ограничений, но в виде отчета, выполненного на системе компоновки данных. Отчет строится по данным закладки «Полная структура» (повторное построение структуры не производится). Данный отчет рекомендуется для просмотра полной структуры затрат в случаях, когда необходимо:
- Установить отборы или выполнить сортировку при просмотре результата;
- Вывести вложенные поля, например Номенклатура.Артикул;
- Красиво вывести структуру себестоимости на печать;
- Вывести данные структуры затрат в диаграмму;
5. **Диаграмма** - выводится свернутая структура затрат. Вывод диаграммы возможен в разрезе статей затрат или затрат+статей затрат. Предусмотрена печать диаграммы. Диаграмма выводится двумя путями:
- с закладки «Диаграмма» - выводится диаграмма всей свернутой структуры затрат;
- с закладки «Свернутая структура» - выводится диаграмма затрат конкретной продукции, на которой установлен курсор мыши.

### Элементы управления и режим работы:

Порядок вывода представлений структуры затрат следующий:

1. Формируется полная структура затрат. Полная структура затрат является источником данных для построения всех остальных представлений;
2. Формируется свернутая структура затрат (на основе полной);
3. Формируется плоская структура затрат (на основе свернутой);
4. Формируется отчет (на основе полной структуры затрат).

Исходя из порядка вывода представлений, для формирования отчета предусмотрено три элемента управления:

1. Кнопка «Сформировать (только дерево)» - формирует полную, свернутую и плоскую структуры затрат;
2. Кнопка «Сформировать все» - формирует полную, свернутую, плоскую структуры затрат и отчет;
3. Кнопка «Сформировать» (кнопка по умолчанию) - формирует только отчет. Однако, если полная структура затрат будет пуста, то также выполнится ее формирование.

### Рекомендации по режиму работы

1. Перед началом работы тщательно настроить периоды выпуска и затрат, отборы, настройки аналитики. В противном случае построение структуры затрат может выполняться неоправданно долго. Стоит помнить, что построение дерева можно остановить комбинацией клавиш Ctrl+Break;
2. Выполнить полное формирование всех представлений структуры затрат;
3. При необходимости, настроить представление отчета (кнопка «Настройки»);
4. Выполнить формирование только отчета (кнопка «Сформировать»). В этом случае полная структура затрат не будет переформировываться и отчет сформируется очень быстро.

### Обновление 31.07.2017 г.

В версии для УПП добавлен функционал отбора затрат. Отбор затрат действует только на представление в виде отчета.

1. Отбор затрат включается на закладке Затраты - флаг "Использовать отбор затрат";
2. Если флаг установлен, становится доступен отбор - он справа от флажка. Отбор СКДшный - так должно быть прикольнее, чем отбор построителя;
3. Устанавливаем отбор по нужным полям, формируем отчет;
4. Важно - отбор действует не на дерево (т.е. полную структуру), а на отчет (т.е. представление полной структуры в виде табличного документа);
Это я сделал намеренно, чтобы можно было сверять результат.
5. Применение отбора к дереву - вещь достаточно необычная для 1С, поэтому результат может показаться необычным.
Поясню свою мысль. В обычных отчетах СКДшных или на запросах дерево бывает двух видов - группировки и иерархия.

При наложении отбора на группировки всегда известно количество уровней дерева, и отбор всегда накладывается на какую-то конкретную группировку. 

Например, на номенклатуру. Поведение отчета при этом тоже предсказуемо - если номенклатура не прошла отбор, то она в отчете не появляется, и все вышестоящие ее группировки - тоже. Просто потому, что верхние группировки полностью зависят от нижних.

Если отчет строится с иерархией - например, тот же справочник номенклатуры - то количество уровней непрогнозируемо. Наложение отбора на значение номенклатуры приводит к тому же результату - если номенклатура его не прошла, то исчезает со всеми вышестоящими уровнями.

Оба вида деревьев в отчетах имеют один существенный недостаток - нельзя сделать такой отбор, чтобы пропало промежуточное значение группировки (которое в середине - ни вверху, ни внизу).

В нашем случае такое не годится, но платформа ничего стоящего предложить не может. Поэтому приходится выкручиваться некрасивыми, обходными методами. Но все вроде получилось.

Отбор в структуре затрат может убрать любую строку, с любого уровня иерархии, при этом происходит перестроение иерархии пересчет сумм.

6. Есть отдельный флажок - Показывать промежуточные строки. Это один из вариантов применения отбора. Если флаг снят, то происходит перестроение дерева с учетом пропавших строк - тех, что не прошли отбор. Если флаг установлен, то все строки остаются на своих местах, но не прошедшие отбор остаются без стоимости и затеняются (меняется цвет текста на серый). Мне показалось, что такой вариант представления информации тоже может быть полезен - чтобы дерево видеть полным, но понимать, где стоят нужные затраты, как, через какие переделы они доходят до продукции.

7. Итоговая сумма - т.е. стоимость изделия, расположенного на верхнем уровне дерева, при установке отбора пересчитывается. Она, по сути, заново собирается из стоимостей тех строк, которые прошли отбор.